<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Skyward - Login</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Segoe UI, system-ui, sans-serif;background:linear-gradient(135deg,#1e3a8a,#3b82f6);min-height:100vh;display:flex;align-items:center;justify-content:center;color:#eef2ff}
    .card{background:#12326a;padding:28px;border-radius:12px;max-width:420px;width:100%;box-shadow:0 6px 18px rgba(12,31,68,.6)}
    h1{font-size:20px;margin-bottom:12px}
    .form{display:grid;gap:10px}
    input{padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);color:#eef2ff}
    button{padding:10px;border-radius:6px;border:0;background:#3b82f6;color:#fff;cursor:pointer}
    .msg{min-height:1.2rem;color:#ffd; margin-top:6px}
    .small{font-size:13px;color:#cfe3ff}
    .or{display:flex;align-items:center;gap:8px;margin:8px 0;color:#cfe3ff}
    .or div{height:1px;background:rgba(255,255,255,.06);flex:1}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signInWithPopup,
      GoogleAuthProvider,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // your firebaseConfig (from prompt)
    const firebaseConfig = {
      apiKey: "AIzaSyDCfHNOVVKam-5F3cALbyfOM65NY_8wP6U",
      authDomain: "skyward-redesign.firebaseapp.com",
      projectId: "skyward-redesign",
      storageBucket: "skyward-redesign.firebasestorage.app",
      messagingSenderId: "509117589982",
      appId: "1:509117589982:web:56a55f2f6bd41c305ad54f",
      measurementId: "G-T69F35DHVN"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM ready
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const expectedRole = (urlParams.get('role') || 'student').toLowerCase();
      document.getElementById('roleTitle').textContent = expectedRole.charAt(0).toUpperCase() + expectedRole.slice(1);

      const loginForm = document.getElementById('loginForm');
      const msgEl = document.getElementById('msg');
      const googleBtn = document.getElementById('googleBtn');
      const signupLink = document.getElementById('signupLink');

      function showMsg(t, err = true) { msgEl.textContent = t; msgEl.style.color = err ? '#ffb3b3' : '#bfffc4'; }

      async function onSignedInRedirect(user) {
        const userDocRef = doc(db, 'users', user.uid);
        const snapshot = await getDoc(userDocRef);
        if (!snapshot.exists()) {
          showMsg('No profile found. Contact admin to set role.');
          await signOut(auth);
          return;
        }
        const role = (snapshot.data().role || '').toLowerCase();
        if (!(role === expectedRole || role === 'admin')) {
          showMsg('Account role does not match this login page.');
          await signOut(auth);
          return;
        }
        localStorage.setItem('skyward_user', snapshot.data().displayName || user.email);
        localStorage.setItem('skyward_role', role);
        if (role === 'admin') window.location.href = 'admin_dashboard.html';
        else if (role === 'teacher') window.location.href = 'teacher_dashboard.html';
        else window.location.href = 'dashboard.html';
      }

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          showMsg('Signed in, verifying role...', false);
          try { await onSignedInRedirect(user); } catch (e) { console.error(e); showMsg('Error verifying role'); }
        }
      });

      loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showMsg('Signing in...', false);
        const email = document.getElementById('username').value.trim();
        const password = document.getElementById('password').value;
        try {
          await signInWithEmailAndPassword(auth, email, password);
        } catch (err) {
          console.error(err);
          showMsg(err.message || 'Sign-in failed');
        }
      });

      googleBtn.addEventListener('click', async () => {
        showMsg('Signing in with Google...', false);
        const provider = new GoogleAuthProvider();
        try {
          const result = await signInWithPopup(auth, provider);
          // If new user, create profile doc with default role 'student'
          if (result && (result._tokenResponse?.isNewUser || result.additionalUserInfo?.isNewUser)) {
            const u = result.user;
            await setDoc(doc(db, 'users', u.uid), {
              displayName: u.displayName || u.email,
              email: u.email,
              role: 'student',
              createdAt: serverTimestamp()
            });
          }
        } catch (err) {
          console.error(err);
          showMsg(err.message || 'Google sign-in failed');
        }
      });

      signupLink.addEventListener('click', async (e) => {
        e.preventDefault();
        const email = prompt('Enter email for new account (will be created as student):');
        const pw = prompt('Enter password (min 8 chars):');
        if (!email || !pw) return;
        showMsg('Creating account...', false);
        try {
          const cred = await createUserWithEmailAndPassword(auth, email, pw);
          const u = cred.user;
          await setDoc(doc(db, 'users', u.uid), {
            displayName: u.email,
            email: u.email,
            role: 'student',
            createdAt: serverTimestamp()
          });
          showMsg('Account created. Verifying...', false);
        } catch (err) {
          console.error(err);
          showMsg(err.message || 'Account creation failed');
        }
      });
    });
  </script>
</head>
<body>
  <div class="card" role="main" aria-label="Login">
    <h1>Triad CUSD 2 â€” <span id="roleTitle">Student</span> Login</h1>

    <form id="loginForm" class="form" autocomplete="off">
      <input id="username" type="email" placeholder="Email" autocomplete="username" required />
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" required />
      <button id="signinBtn" type="submit">Sign in</button>
      <div class="msg" id="msg" aria-live="polite"></div>
      <div class="or"><div></div><div class="small">OR</div><div></div></div>
      <button id="googleBtn" type="button">Sign in with Google</button>
      <p class="small">Need an account? <a id="signupLink" href="#" style="color:#bfe1ff">Create one</a></p>
    </form>
  </div>
</body>
</html>